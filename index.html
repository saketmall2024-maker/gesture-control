<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thumbs Up / Down Tracker</title>
<style>
body { margin:0; overflow:hidden; background:black; }
video, canvas {
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// ESP32 IP (for NeoPixel control)
const ESP_IP = "http://192.168.0.102/";

// Open camera
navigator.mediaDevices.getUserMedia({video: {facingMode:"environment"}})
.then(stream => video.srcObject = stream);

video.addEventListener("loadeddata", () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  hands.send({image: video});
});

// Send color to ESP32
let lastCommand = "";
function sendColor(cmd){
  if(cmd !== lastCommand){
    fetch(ESP_IP + cmd).catch(()=>{});
    lastCommand = cmd;
  }
}

// MediaPipe Hands setup
const hands = new Hands({locateFile: (file) => {
  return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
}});
hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.5
});

hands.onResults(results => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0){
    const landmarks = results.multiHandLandmarks[0];

    // Simple thumb detection (vertical relative to wrist)
    const wristY = landmarks[0].y;
    const thumbTipY = landmarks[4].y;

    if(thumbTipY < wristY){
      ctx.fillStyle = "green";
      ctx.font = "40px Arial";
      ctx.fillText("ðŸ‘ THUMBS UP", 20, 60);
      sendColor("LEFT");   // map green to NeoPixel LEFT
    } else {
      ctx.fillStyle = "red";
      ctx.font = "40px Arial";
      ctx.fillText("ðŸ‘Ž THUMBS DOWN", 20, 60);
      sendColor("RIGHT");  // map red to NeoPixel RIGHT
    }

    // Draw hand landmarks
    drawConnectors(ctx, landmarks, HAND_CONNECTIONS,
                   {color: '#00FF00', lineWidth:2});
    drawLandmarks(ctx, landmarks, {color:'#FF0000', lineWidth:1});
  }

  hands.send({image: video});
});
</script>

</body>
</html>
